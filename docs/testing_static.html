<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Testing - Static Code Analysis · Amido Stacks Webapp</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="We are using [SonarQube](https://docs.sonarqube.org/) for static analysis. To enable integrations with GitHub and for use in Azure Devops CI, the results are then hosted and viewable on [SonarCloud](https://sonarcloud.io/)."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Testing - Static Code Analysis · Amido Stacks Webapp"/><meta property="og:type" content="website"/><meta property="og:url" content="https://amido.github.io/stacks-webapp-template/"/><meta property="og:description" content="We are using [SonarQube](https://docs.sonarqube.org/) for static analysis. To enable integrations with GitHub and for use in Azure Devops CI, the results are then hosted and viewable on [SonarCloud](https://sonarcloud.io/)."/><meta property="og:image" content="https://amido.github.io/stacks-webapp-template/img/logo.png"/><meta name="twitter:card" content="summary"/><meta name="robots" content="noindex"/><link rel="shortcut icon" href="/stacks-webapp-template/img/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script src="/stacks-webapp-template/js/scrollSpy.js"></script><link rel="stylesheet" href="/stacks-webapp-template/css/main.css"/><script src="/stacks-webapp-template/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/stacks-webapp-template/"><img class="logo" src="/stacks-webapp-template/img/thumbnail_stacks.png" alt="Amido Stacks Webapp"/><h2 class="headerTitleWithLogo">Amido Stacks Webapp</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/stacks-webapp-template/docs/" target="_self">Docs</a></li><li class="siteNavGroupActive"><a href="/stacks-webapp-template/docs/monorepo" target="_self">About Stacks</a></li><li class=""><a href="https://github.com/amido/stacks" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Testing</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Getting Started<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/stacks-webapp-template/docs/">About Amido Stacks</a></li><li class="navListItem"><a class="navItem" href="/stacks-webapp-template/docs/getting_started_demo">Demo - Using the scaffolding-cli to build an application</a></li><li class="navListItem"><a class="navItem" href="/stacks-webapp-template/docs/getting_started_dev">Dev - Using the repo to build an application</a></li><li class="navListItem"><a class="navItem" href="/stacks-webapp-template/docs/monorepo">Stacks Monorepo</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Guides<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/stacks-webapp-template/docs/deployment">Deployment</a></li><li class="navListItem"><a class="navItem" href="/stacks-webapp-template/docs/publishing">Publishing Packages</a></li><li class="navListItem"><a class="navItem" href="/stacks-webapp-template/docs/publishing_nuget">Publishing NuGet Packages</a></li><li class="navListItem"><a class="navItem" href="/stacks-webapp-template/docs/pipeline_templates">Pipeline Templates</a></li><li class="navListItem"><a class="navItem" href="/stacks-webapp-template/docs/infrastructure_code">Infrastructure</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Testing<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/stacks-webapp-template/docs/testing">Testing and Quality</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/stacks-webapp-template/docs/testing_static">Static Code Analysis</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Packages<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/stacks-webapp-template/docs/packages">Packages</a></li><li class="navListItem"><a class="navItem" href="/stacks-webapp-template/docs/cli_process">CLI</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Supporting Docs<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/stacks-webapp-template/docs/browser_support">Browser Support</a></li><li class="navListItem"><a class="navItem" href="/stacks-webapp-template/docs/server_side_cache">Server Side Cache</a></li><li class="navListItem"><a class="navItem" href="/stacks-webapp-template/docs/faq">FAQ</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="/edit/master/docs/testing_static.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 id="__docusaurus" class="postHeaderTitle">Testing - Static Code Analysis</h1></header><article><div><span><p>We are using <a href="https://docs.sonarqube.org/">SonarQube</a> for static analysis. To enable integrations with GitHub and for use in Azure Devops CI, the results are then hosted and viewable on <a href="https://sonarcloud.io/">SonarCloud</a>.</p>
<p>SonarCloud offers quality gates that ensure that your standards are adhered to before deploying.</p>
<p><img src="https://amidostacksassets.blob.core.windows.net/docs/assets/sonarcloud_overview.png" alt="sonarcloud_example">
<img src="https://amidostacksassets.blob.core.windows.net/docs/assets/sonarcloud_github.png" alt="sonarcloud_github"></p>
<p>SonarCloud supports most languages.</p>
<h2><a class="anchor" aria-hidden="true" id="getting-started"></a><a href="#getting-started" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Getting Started</h2>
<p>Sign up with GitHub to <a href="https://sonarcloud.io">Sonarcloud</a> for the Organisation under test. Review the documentation and setup on how to puglin to GitHub.</p>
<h2><a class="anchor" aria-hidden="true" id="using-jest-with-sonarcloud"></a><a href="#using-jest-with-sonarcloud" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using Jest with SonarCloud</h2>
<p>SonarCloud collects the coverage reports generated by Jest in the form of <code>lcov.info</code> output. Configuration in the <code>jest.config.json</code> file will include the following for code coverage collection.</p>
<p>⚠️ IMPORTANT: To ensure that the <code>lcov.info</code> reports with <em>relative paths</em> the root  <code>&quot;roots&quot;: [&quot;&lt;rootDir&gt;/.&quot;]</code> needs to be set. Else then the <code>lcov</code> report will embed the root directory in the path, and sonar scanner won't be able to map the coverage to the analysed files.</p>
<pre><code class="hljs css language-json">{
  ...
"roots": ["&lt;rootDir&gt;/."],
"coverageReporters": ["cobertura", "lcov"],
  "collectCoverage": true,
  "collectCoverageFrom": [
    "**/*.{ts,tsx}",
    "!**/*.test.*",
    "!&lt;rootDir&gt;/.*",
    "!**/*config.{js,json}",
    "!&lt;rootDir&gt;/coverage",
    "!&lt;rootDir&gt;/__tests__/**/*",
    "!&lt;rootDir&gt;/__mocks__/**/*"
  ],
  "coverageDirectory": "&lt;rootDir&gt;/coverage/",
  "coverageThreshold": {
    "global": {
      "statements": 1,
      "branches": 1,
      "functions": 1,
      "lines": 1
    }
  }
  ...
}
</code></pre>
<p>The coverage directory will be where the <code>lcov</code> reports are generated.</p>
<h2><a class="anchor" aria-hidden="true" id="configuring-sonarcloud"></a><a href="#configuring-sonarcloud" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configuring SonarCloud</h2>
<p>At the root of the package, a <code>sonar-project.properties</code> configuration file can be created, to pull in the required SonarCloud environment variaables, including SonarCloud token, project name, where to collect the code coverage report from, and what files should be exluded from analysis.</p>
<p>For all configration options see <a href="https://sonarcloud.io/documentation/analysis/analysis-parameters/">SonarCloud Analysis Parameters</a>.</p>
<p>To pull in the Jest generated code coverage reports, outputted in the SonarCloud supported <code>lcov.info</code> report, the report path can be set in the <code>sonar-project.properties</code> file:</p>
<pre><code class="hljs css language-bash"><span class="hljs-comment"># sonar-project.properties</span>
sonar.javascript.lcov.reportPaths=coverage/lcov.info
</code></pre>
<p>To ensure that SonarCloud doesn't analysis files that are not needed for analysis, please exclude them:</p>
<pre><code class="hljs css language-bash"><span class="hljs-comment"># sonar-project.properties</span>
sonar.exclusions=node_modules/**/*, dist/**/*, coverage/**/*, **/*.<span class="hljs-built_in">test</span>.*, *.config.{js,json}, __tests__/**/*, __mocks__/**/*, ./.*, *.xml, **/*.d.*, **/*.js
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="amidostacksci-sonarscanner"></a><a href="#amidostacksci-sonarscanner" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>amidostacks/ci-sonarscanner</h2>
<p>We can run this with Amido Stacks custom container, supports running Sonar Scanner for .NET and NPM projects.</p>
<p>See <a href="https://hub.docker.com/repository/docker/amidostacks/ci-sonarscanner">amidostacks/ci-sonarscanner</a> for the open source image.</p>
<h3><a class="anchor" aria-hidden="true" id="azure-pipelines"></a><a href="#azure-pipelines" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Azure Pipelines</h3>
<p>Running in this container makes static code analysis a breeze in the pipelines. For an example on how to use the container to run you static code analysis, see <a href="https://github.com/amido/stacks-pipeline-templates/blob/feature/cycle2/azDevOps/azure/templates/v2/steps/test-static-code-sonar.yml">amido/stacks-pipeline-templates</a></p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">steps:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">bash:</span> <span class="hljs-string">|
      sonar-scanner -v
      sonar-scanner
</span>    <span class="hljs-attr">displayName:</span> <span class="hljs-string">"Static Analysis: SonarScanner Run"</span>
    <span class="hljs-attr">target:</span>
      <span class="hljs-attr">container:</span> <span class="hljs-string">sonar_scanner</span>
    <span class="hljs-attr">env:</span>
      <span class="hljs-attr">SONAR_HOST_URL:</span> <span class="hljs-string">https://sonarcloud.io</span>
      <span class="hljs-attr">SONAR_TOKEN:</span> <span class="hljs-string">$SONAR_TOKEN</span>
      <span class="hljs-attr">SONAR_PROJECT_KEY:</span> <span class="hljs-string">$SONAR_PROJECT_KEY</span>
      <span class="hljs-attr">SONAR_ORGANIZATION:</span> <span class="hljs-string">$SONAR_ORGANIZATION</span>
      <span class="hljs-attr">BUILD_NUMBER:</span> <span class="hljs-string">$(Build.BuildNumber)</span>
    <span class="hljs-attr">workingDirectory:</span> <span class="hljs-string">${{</span> <span class="hljs-string">parameters.workingDirectory</span> <span class="hljs-string">}}</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="running-locally"></a><a href="#running-locally" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Running locally</h3>
<p>In order to run, the export the followings environment variables for the
SonarCloud Project:</p>
<pre><code class="hljs css language-bash"><span class="hljs-built_in">export</span> SONAR_TOKEN=
<span class="hljs-built_in">export</span> SONAR_PROJECT_KEY=
<span class="hljs-built_in">export</span> SONAR_ORGANIZATION=
<span class="hljs-built_in">export</span> BUILD_NUMBER=
</code></pre>
<p>First generate the code coverage results but running the unit tests, then run the SonarCloud scanner and
push up the results for analysis.</p>
<pre><code class="hljs css language-bash">npm run <span class="hljs-built_in">test</span>
docker run -e SONAR_HOST_URL=https://sonarcloud.io -e SONAR_TOKEN=<span class="hljs-variable">$SONAR_TOKEN</span> -e SONAR_PROJECT_KEY=<span class="hljs-variable">$SONAR_PROJECT_KEY</span> -e SONAR_ORGANIZATION=<span class="hljs-variable">$SONAR_ORGANIZATION</span> -e BUILD_NUMBER=1.2.3 -v $(<span class="hljs-built_in">pwd</span>):/usr/src --rm -it amidostacks/ci-sonarscanner /bin/bash -c <span class="hljs-string">'cd /usr/src &amp;&amp; sonar-scanner'</span>
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/stacks-webapp-template/docs/testing"><span class="arrow-prev">← </span><span>Testing and Quality</span></a><a class="docs-next button" href="/stacks-webapp-template/docs/packages"><span>Packages</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#getting-started">Getting Started</a></li><li><a href="#using-jest-with-sonarcloud">Using Jest with SonarCloud</a></li><li><a href="#configuring-sonarcloud">Configuring SonarCloud</a></li><li><a href="#amidostacksci-sonarscanner">amidostacks/ci-sonarscanner</a><ul class="toc-headings"><li><a href="#azure-pipelines">Azure Pipelines</a></li><li><a href="#running-locally">Running locally</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/stacks-webapp-template/" class="nav-home"><img src="/stacks-webapp-template/img/thumbnail_stacks.png" alt="Amido Stacks Webapp" width="66" height="58"/></a><div><h5>Docs</h5><a href="/stacks-webapp-template/docs/en/index">Getting Started</a></div><div><h5>Community</h5><a href="https://amido.com/">Amido</a></div><div><h5>More</h5><a href="https://github.com/">GitHub</a></div></section><a href="https://github.com/amido/stacks" target="_blank" rel="noreferrer noopener" class="fbOpenSource"><img src="/stacks-webapp-template/img/logo.png" alt="stacks-webapp-template" width="170" height="45"/></a><section class="copyright">Copyright © 2020 Amido Ltd</section></footer></div><script src="http://localhost:undefined/livereload.js"></script></body></html>